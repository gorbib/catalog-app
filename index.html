<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Электронный каталог</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.17/vue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue-resource/1.5.1/vue-resource.min.js"></script>
    <script src="https://cdn.ravenjs.com/3.26.2/vue/raven.min.js" crossorigin="anonymous"></script>
    <script>Raven.config('https://10eec8d228d94bbb826162bf93943ff3@sentry.io/1231410').install();</script>

    <style>
    *, :after, :before {
        box-sizing: border-box;
    }
    html, body {
        height: 100%;
        margin:0;
        padding: 0;
        overflow: hidden;
    }

    :root {
        --main-bg-color: #f5f6f9;
        --block-bg-color: #fff;
        --black-color: #3d3b48;
        --accent-color: #8194fb;
    }

    [v-cloak] {
        display: none !important;
    }

    #app {
        -webkit-font-smoothing: antialiased;
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        background-color: var(--main-bg-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }
    .topbar {
        background-color: var(--block-bg-color);
        text-align: center;
        padding: 20px;
        box-shadow: 0px 10px 20px 0px rgba(0, 0, 0, 0.05);
        z-index: 10;
        position: relative;
    }
    .topbar__title {
        font-weight: bold;
        color: var(--black-color);
    }
    .topbar__subtitle {
        margin-top: 5px;
        font-size: 14px;
        color: #9f9fb2;
    }
    .layout {
        overflow-y: scroll;
        -webkit-overflow-scrolling: touch;
        display: flex;
        flex-grow: 1;
        flex-direction: column;
    }
    .search-field {
        font-size: 16px;
        padding: 20px;
        margin: 20px;
        background-color: #fff;
        border-radius: 5px;
        border: none;
        outline: none;
        box-shadow: 0px 10px 20px 0px rgba(0, 0, 0, 0.05);
        -webkit-appearance: none;
    }
    .search-field::-webkit-input-placeholder {
        color: #86889e;
    }
    .search-results-title {
        padding: 20px;
        font-weight: bold;
        color: var(--black-color);
    }
    .books-list {
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
    }
    .book {
        margin: 10px 20px;
        padding: 20px;
        background-color: var(--block-bg-color);
        border-radius: 5px;
        border-left: 5px solid var(--accent-color);
        cursor: pointer;
    }
    .book__title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 10px;
        color: var(--black-color);
    }
    .book__subtitle {
        color: #9f9fb2;
        font-size: 14px;
        margin-bottom: 10px;
    }
    .book__author {
        color: #9f9fb2;
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 10px;
    }
    .book__summary {
        display: none;
        font-style: italic;
        font-size: 14px;
        color: #a2a4b5;
        margin: 15px 0;
        line-height: 1.4;
    }
    .book__department {
        font-size: 14px;
    }
    .book__extra {
        margin-top: 20px;
        font-size: 14px;
        font-weight: 300;
    }
    .book__contents {
        margin-top: 20px;
    }
    .expands {
        display: none;
    }
    .book--expanded .expands {
        display: block;
    }
    .book mark {
        background-color: var(--accent-color);
        border-radius: 3px;
        color: #fff;
    }
    .splashscreen {
        display: flex;
        align-items: center;
        flex-grow: 1;
        justify-content: center;
    }
    .preloader {
        display: flex;
        align-items: center;
        flex-grow: 1;
        flex-shrink: 0;
        justify-content: center;
        margin: 20px;
    }
    .load-more-button {
        background-color: var(--block-bg-color);
        cursor: pointer;
        color: var(--accent-color);
        font-size: 16px;
        font-weight: bold;
        border: none;
        border-bottom:2px solid var(--accent-color);
        border-radius: 5px;
        margin:20px;
        padding: 20px;
        flex-grow: 1;
        flex-shrink: 0;
        outline: none;
    }
    .books-enter-active, .books-leave-active {
        transition: all 0.4s ease-out;
    }
    .books-enter, .books-leave-to {
        opacity: 0;
    }

    .books-enter-to, .books-leave {
        opacity: 1;
    }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <header class="topbar">
            <div class="topbar__title">Каталог книг библиотеки им. Селянина</div>
            <div class="topbar__subtitle" v-if="totalCount">{{totalCount | localizeNumber}} {{totalCount | pluralize('книга,книги,книг')}}</div>
        </header>
        <div class="layout">
            <input type="search" v-model="query" class="search-field" placeholder="Напиши название книги или имя автора">
            <div class="search-results-title" v-if="resultsCount > 0">{{resultsCount | pluralize('Найдена,Найдены,Найдено')}} {{resultsCount | localizeNumber}} {{resultsCount | pluralize('книга,книги,книг')}}</div>
            <transition-group appear name="books" class="books-list" tag="div">
                <book :record="record" :query="query" v-for="record in records" :key="record.id"></book>
            </transition-group>
            <div class="splashscreen" v-if="resultsCount == 0 && !loading"><span>Книги не найдены</span></div>
            <div class="preloader" v-if="loading">
                <svg width="120" height="30" xmlns="http://www.w3.org/2000/svg" fill="#8194fb">
                    <circle cx="15" cy="15" r="15">
                      <animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite"/>
                      <animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="60" cy="15" r="9" fill-opacity=".3">
                      <animate attributeName="r" from="9" to="9" begin="0s" dur="0.8s" values="9;15;9" calcMode="linear" repeatCount="indefinite"/>
                      <animate attributeName="fill-opacity" from=".5" to=".5" begin="0s" dur="0.8s" values=".5;1;.5" calcMode="linear" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="105" cy="15" r="15">
                      <animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite"/>
                      <animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite"/>
                    </circle>
                  </svg>
            </div>
            <button class="load-more-button" v-if="hasMorePages" @click="loadMore">Показать больше результатов</button>
        </div>
    </div>

    <template id="book">
        <div class="book" v-bind:class="{'book--expanded': expanded}" @click="expand">
            <div class="book__title" v-html="$options.filters.highlightMatches(record.title, query)"></div>
            <div class="book__author" v-if="this.expanded" v-html="$options.filters.highlightMatches(record.author, query)"></div>
            <div class="book__author" v-else v-html="$options.filters.highlightMatches(record.full_name, query)"></div>
            <div class="book__subtitle expands" v-if="record.title_info">{{record.title_info}}<template v-if="record.extra['#215']">, {{record.extra['#215']}}</template></div>
            <div class="book__summary expands" v-html="$options.filters.highlightMatches(record.summary, query)"></div>
            <div class="book__department">{{department}}</div>
            <details class="book__contents" v-if="record.extra['#330'][0] !== ''">
                <summary v-on:click.stop>Содержание</summary>
                <ul>
                    <li v-for="item in record.extra['#330']" v-html="$options.filters.highlightMatches(item, query)"></li>
                </ul>
            </details>
            <div class="book__extra expands"><span>{{record.extra["#210"][0]}}</span> &bull; <span>{{record.extra["#621"][0]}}</span> &bull; <span>{{record.extra["#606"][0]}}</span></div>
        </div>
    </template>
</body>
<script>

    Vue.component('book', {
        template: '#book', 
        props: ['record', 'query'],
        data: function() {
            return {
                expanded: false
            }
        },
        methods: {
            expand: function() {
                this.expanded = !this.expanded;
            }
        },
        filters: {
            highlightMatches: function (string, searchTerm) {
                if (!searchTerm) return string;
                if (!string) return;
                return string.replace(new RegExp("(" + searchTerm + ")", "ig"), "<mark>$1</mark>");
            }
        },
        computed: {
            department: function() {
                // Unique strings
                return this.record.department.split(', ').filter((el, i, a) => i === a.indexOf(el)).join(', ');
            }
        }
    });

    var app = new Vue({
        el: '#app',
        data () {
            return {
                records: [],
                source: '',
                query:'',
                resultsCount: 0,
                totalCount: 0,
                page: 1,
                loading: false,
                recordsPerPage: 10 // API limit
            }
        },
        created: function () {
            this.getRecords()
        },
        methods: {
            getRecords: function() {
                this.loading = true;

                this.$http.get(
                    'https://ec.gorbib.org.ru/records/getrecords' + (this.query ? '/body:' + encodeURI(this.query) : '') + '/page:' + this.page,
                    // abot previous request
                    {
                        before(request) {
                            if (this.previousRequest) {
                                this.previousRequest.abort();
                            }
                            this.previousRequest = request;
                        }
                }).then(response => {
                    this.loading = false;
                    this.records = this.records.concat(response.data.records);
                    
                    this.totalCount = response.data.total_total;
                    if (typeof this.records[0] !== 'undefined') {
                        this.resultsCount = this.records[0].total;
                    } else {
                        this.resultsCount = 0;
                    } 
                },
                error => {
                    // Do nothing. Most of network errors brcause we abort requests
                });
            },
            loadMore: function() {
                this.page += 1;
                this.getRecords();
            }
        },
        watch: {
            query: function(val) {
                this.records = [];
                this.resultsCount = 0;
                this.page = 1;
                this.getRecords();
            }
        },
        filters: {
            pluralize: function (n, values) {
                if (typeof n === 'undefined') return;

                var values = values.split(',');

                var one = values[0];
                var few = values[1];
                var many = values[2];

                n = Math.abs(n);
                n %= 100;
                if (n >= 5 && n <= 20) {
                    return many;
                }
                n %= 10;
                if (n === 1) {
                    return one;
                }
                if (n >= 2 && n <= 4) {
                    return few;
                }
                return many;
            },
            localizeNumber: function(number) {
                return number.toLocaleString();
            }
        },
        computed: {
            hasMorePages: function() {
                return (this.page * this.recordsPerPage) < this.resultsCount;
            }
        }
    });
</script>
</html>